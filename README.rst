О программе
===========

Программа предназначена для организации репозитория подсистем **"ЕИИС Соцстрах"** или других прикладных программ. 
Репозиторий создается как эталонный ресурс с доступом по сети для установки, обновления и удаления пакетов программ на рабочих местах (РМ) сотрудников. 
Для обновления пакетов на рабочих местах, используется `клиент`_: **"Обновление ЕИИС Соцстрах. Клиент"**.

Общие понятия
=============

- Под *репозиторием* понимается любая папка на локальном компьютере или сетевом диске, с располагающимися там папками подсистем ЕИИС Соцстрах или иных программ.
- Все папки в репозитории считаются *пакетами*, содержащие программы. Файлы в корне репозитория игнорируются.
- Под индексированием понимается создание индекс файла в корне репозитория с информацией о пакетах.
- При индексации файлы в пакетах репозитория не изменяются.

Работа с программой
===================

Инициализация репозитория
=========================

Для начала требуется инициализировать репозиторий:

::

    indexer.exe -r \\server\repo\path init
    indexer.exe -r C:\server\repo\path init

Требуется указать полный или относительный (относительно программы indexer.exe) путь к репозиторию.
Также можно создать файл c именем ``indexer.conf`` рядом с исполняемым файлов индексатора с указанием пути к репозиторию формата, чтобы не указывать путь в параметрах:

.. code-block:: json

    {
        "repo": "полный или относительный путь к репозиторию"
    }

::

    indexer.exe init

В дальнейшем в данном руководстве будут показываться примеры обоих вариантов.

Блокировка пакетов [2]_
=======================

По-умолчанию, программа индексирует все пакеты, находящиеся в репозитории. 
При необходимости исключить определенные пакеты от доступности пользователей, пакеты можно заблокировать. 
При этом фактически пакеты останутся в репозитории, но в клиенте они отображаться не будут. 
Для блокировки одного пакета следует передать имя этого пакета команде ``disable`` или через конвейер, 
указав полный путь к файлу с перечнем пакетов (см. `Формат служебных файлов`_):

::

    indexer.exe -r \\server\repopath disable Пакет
    indexer.exe disable "Другой пакет"
    indexer.exe disable < "путь к файлу с перечнем пакетов" (в кодировке utf8)

Пакеты, содержащие пробелы в своем имени, необходимо заключать в кавычки.
Пакеты, передаваемые через служебный файл, можно указывать без кавычек.
Для разблокировки пакета(ов) аналогичным образом используется команда ``enable``.

Псевдонимы пакетов [2]_
=======================

Если имя пакет содержит латинские буквы или достаточно длинное, то для облегчения восприятия наименований пакетов можно задать псевдонимы.
При наличии у пакета псевдонима, в *Клиенте* у пользователя и на ярлыке запуска подсистемы будет указан псевдоним.

Действия для установки псевдонима пакету или пакетам, аналогично предыдущей команде) используя команду ``alias``:

::

    indexer.exe -r \\server\repopath alias set Псевдоним Подсистема
    indexer.exe alias set "Другой псевдоним" "Другой пакет"
    indexer.exe alias set < С:\путь\к\файлу (в кодировке utf8)

Если псевдоним уже существует, он будет обновлен. Для удаления псевдонима:

::

    indexer.exe -r \\server\repopath alias del Псевдоним
    indexer.exe -r \\server\repopath alias del "Другой псевдоним"
    indexer.exe -r \\server\repopath alias del all

Последняя команда удаляет все псевдонимы

Запуск команды без параметров выводит информацию по существующим псевдонимам:

::

    indexer.exe -r \\server\repopath alias

Данные о блокировках и псевдонимах хранятся в БД репозитория.

Блокировка репозитория
======================

Перед индексацией, выгрузкой индекс-файла репозиторий необходимо перевести в режим *регламентных работ*, для исключения работы с репозиторием клиентов во время регламента.

::

    indexer.exe -r \\server\repopath regl on

Без указания подкоманд on|off будет выведет статус регламента:

::

    indexer.exe -r \\server\repopath regl

Индексация [1]_
===============

После инициализации репозитория, блокировок пакетов, указаний псевдонимов и перевода репозитория в режим регламента можно запускать процесс индексации.
Данная команда произведет полную индексацию репозитория: 

::

    indexer.exe -r \\server\repopath index

В дальнейшем, после обновления файлов в пакетах, индексацию можно проводить частично, указав только требуемые пакеты:

::

    indexer.exe index ПАКЕТ "ПАКЕТ №2"

При создании или удалении псевдонимов или блокировок пакетов, повторная индексация также не требуется. 

Исполняемые файлы пакетов
=========================

После индексации необходимо найти и указать исполняемые файлы пакетов для дальнейшей установки ярлыков на рабочем месте:

::

    indexer.exe exec check

- произведет поиск и определение исполняемого файла во всех пакетах. При дальнейшем запуске команды ``check`` программа будет искать только в новых пакетах

::

    indexer.exe exec check ПАКЕТ "ДРУГОЙ ПАКЕТ"

- произведет поиск и определение исполняемого файла указанных пакетов

::

    indexer.exe exec check set 

- произведет сброс и принудительный поиск и определение исполняемых файлов

::

    indexer.exe exec del [ПАКЕТ ["ДРУГОЙ ПАКЕТ"]]

- программа удалит данные об исполняемых файлах

::

    indexer.exe exec show

- выведет список установленных исполняемых файлов для пакетов

Повторная индексация также не требуется. 

Обновление файла индекса [1]_ [2]_
==================================

По окончанию процесса индексации, определения исполняемых файлов, блокировки пакетов или установки псевдонима, 
а также при случайном удалении файла индекса в репозитории или действия иных факторов, не позволяющих прочитать индекс, 
требуется выгрузить данные в *индекс-файл* командой ``pop``:

::

    indexer.exe -r \\server\repopath pop

Снятие блокировки
=================

По окончании индексации необходимо снять блокировку репозитория, для возможности работы клиента:

::

    indexer.exe regl off


Статус репозитория
==================

Статус репозитория можно узнать командой:

::

    indexer.exe status

Команда выведет информацию о режиме регламента, количестве пакетов в репозитории, количество проиндексированных и заблокированных пакетов, 
а также данные о служебных индексных файлах и версии БД.

Очистка данных
==============

В случае необходимости очистки данных блокировок, псевдонимов или индекса, нужно запустить программу с командой ``cleardb`` с указанием области очистки:

::

    indexer.exe cleardb index   - удаление данных индекса
    indexer.exe cleardb alias   - удаление данных псевдонимов
    indexer.exe cleardb status  - удаление данных блокировок
    indexer.exe cleardb all     - удаление всех данных индексации

Перечень доступных команд и параметров
======================================

Для вывода доступных параметров и команд запустите программу с параметром ``-h``:

::

    indexer.exe -h

Команды программы
=================

init
    инициализация репозитория.

status
    вывод информации о состоянии репозитория

regl [on|off]
    статус, активация/деактивация режима регламента

index [|PACKS|] [1]_
    индексация всего репозитория или отдельных пакетов

exec check | set | del | show [|PACKS|]
    поиск, установка/удаление, вывод исполняемого файла для пакета

pop [1]_
    выгрузка данных проиндексированного репозитория в индекс-файл
    
disable |PACKS| | <stdin
    блокировка пакетов по указанию имени пакета или чтением из стандартного ввода
    
enable |PACKS| | <stdin
    снятие блокировок пакетов по указанию имени пакета или чтением из стандартного ввода
    
alias show | set ПАКЕТ=ПСЕВДОНИМ [...] | set <stdin | del ПСЕВДОНИМ [...] | del <stdin
    вывод установленных псевдонимов пакетов, установка/удаление псевдонимов
    
list
    Вывод пакетов в репозитории и их статус
    
migrate
    миграция данных при изменении структуры БД

clean
    упаковка и переиндексация данных БД

cleardb index | alias | status | all
    очистка данных индекса, псевдонимов, блокировок или всех данных в БД

Параметры запуска программы
===========================

``-r ПУТЬ`` [*]_ 
    полный путь к репозиторию

``-h``
    вывод помощи по программе
    
``-d``
    вывод дополнительной информации (режим отладки)

``-f``
    принудительная полная индексация

``-v``
    версия программы

_`Формат служебных файлов`
==========================

    **команды enable < FILENAME, disable < FILENAME**

Файл с перечнем пакетов подсистем, исключаемых из индексации. Клиенты, при обновлении не увидят исключенных подсистем. 
Наименования исключаемых пакетов требуется добавить вручную по одному на строку без кавычек.
Строка начинающаяся с # (считается комментарием) и пробел игнорируются.

Формат: ``ИМЯ ПАКЕТА``

Например:

:: 

    Оздоровление детей    - исключено из индексирования
    # Бухгалтерия         - закомментировано, индексируется

Файл должен быть в кодировке *UTF-8*

    **команда alias set < FILENAME, del < FILENAME**

Назначение псевдонимов для пакетов подсистем. 
Требуется для приемлемого отображения пакетов в Клиенте и для присвоения указанного псевдонима ярлыку на рабочем столе сотрудника.

Строка начинающаяся с # (считается комментарием) и пробел игнорируются.

Формат: ``ИМЯ ПАКЕТА=ПСЕВДОНИМ``

Например:

::

    winxmlsvalidator=Модуль контроля XML             - ярлык для winxmlsvalidator, будет иметь имя Модуль контроля XML
    Справочник перехода на ОКВЭД ОК 029-2014=ОКВЭД2
    RapRep=Быстрые отчеты
    # Реестр листков нетрудоспособности=Больничные   - игнорируется

Файл должен быть в кодировке *UTF-8*

___________

.. [*] обязательный параметр

.. [1] требуется блокировка репозитория

.. [2] по необходимости

.. _`клиент`: https://github.com/fss6600/repoindexer

.. |PACKS| replace:: ПАКЕТ ["ДРУГОЙ ПАКЕТ" [...]]